{"version":3,"sources":["kaleidosync/spotify-connect.js"],"names":["SpotifyConnect","demo","accessToken","Cookies","get","refreshToken","refreshCode","headers","Authorization","Accept","currentlyPlaying","trackAnalysis","trackProgress","trackFeatures","intervals","types","active","next","last","initial","hooks","forEach","type","delay","window","performance","now","Promise","resolve","reject","fetch","then","res","json","catch","err","item","id","reset","progress","timestamp","progress_ms","i","length","updateTrackProgress","index","start","interval","initialize","bind","call","recursionDelay","duration","timeout","setTimeout","executeIntervalHooks","determineInitialIntervals"],"mappings":"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","file":"spotify-connect.js","sourcesContent":["import Cookies from '../lib/js.cookie'\n\nclass SpotifyConnect {\n  constructor(demo) {\n    this.demo = demo\n\n    this.accessToken = Cookies.get('KALEIDOSYNC_ACCESS_TOKEN')\n    this.refreshToken = Cookies.get('KALEIDOSYNC_REFRESH_TOKEN')\n    this.refreshCode = Cookies.get('KALEIDOSYNC_REFRESH_CODE')\n    this.headers = {\n      Authorization: 'Bearer ' + this.accessToken,\n      Accept: 'application/json'\n    }\n    \n    this.currentlyPlaying = {}\n    this.trackAnalysis = {} \n    this.trackProgress = {}\n    this.trackFeatures = {}\n\n    this.intervals = {\n      types: ['tatums', 'segments', 'beats', 'bars', 'sections'],\n      active: {},\n      next: {},\n      last: {},\n      initial: {},\n      hooks: {}\n    }\n\n    this.intervals.types.forEach((type) => {\n      this.intervals.active[type] = {}\n      this.intervals.next[type] = {}\n      this.intervals.last[type] = {}\n      this.intervals.initial[type] = {}\n      this.intervals.hooks[type] = () => {}\n    })\n  }\n\n  getCurrentlyPlaying() {\n    const delay = window.performance.now()\n\n    if (this.demo) {\n       return new Promise((resolve, reject) => {\n         fetch('/data/currently-playing.json')\n          .then((res) => res.json())\n          .then((res) => resolve({...res, delay: window.performance.now() - delay}))\n          .catch((err) => reject(err))\n       })\n    }\n\n    return new Promise((resolve, reject) => {\n      fetch('https://api.spotify.com/v1/me/player/currently-playing', { headers: this.headers })\n        .then((res) => res.json())\n        .then((res) => resolve({...res, delay: window.performance.now() - delay}))\n        .catch((err) => reject(err))\n    })\n  }\n\n  getTrackFeatures() {\n    if (this.demo) {\n      return new Promise((resolve, reject) => {\n        fetch(`/data/track-features.json`)\n          .then((res) => res.json())\n          .then((res) => resolve(res))\n          .catch((err) => reject(err))\n      })\n    }\n\n    return new Promise((resolve, reject) => {\n      fetch(`https://api.spotify.com/v1/audio-features/${this.currentlyPlaying.item.id}`, { headers: this.headers })\n        .then((res) => res.json())\n        .then((res) => resolve(res))\n        .catch((err) => reject(err))\n    })\n  }\n\n  getTrackAnalysis() {\n    if (this.demo) {\n      return new Promise((resolve, reject) => {\n        fetch(`/data/track-analysis.json`)\n          .then((res) => res.json())\n          .then((res) => resolve(res))\n          .catch((err) => reject(err))\n      })\n    }\n\n    return new Promise((resolve, reject) => {\n      fetch(`https://api.spotify.com/v1/audio-analysis/${this.currentlyPlaying.item.id}`, { headers: this.headers })\n        .then((res) => res.json())\n        .then((res) => resolve(res))\n        .catch((err) => reject(err))\n    })\n  }\n\n  updateTrackProgress(delay, reset) {\n    if (reset) {\n      this.trackProgress = {\n        progress: 0,\n        timestamp: window.performance.now()\n      }\n      return\n    }\n\n    if (delay) {\n      this.trackProgress = {\n        progress: this.currentlyPlaying.progress_ms + delay,\n        timestamp: window.performance.now()\n      }\n      return\n    } \n\n    this.trackProgress = { \n      progress: this.trackProgress.progress + (window.performance.now() - this.trackProgress.timestamp),\n      timestamp: window.performance.now()\n    }\n  }\n\n  determineInitialIntervals(type) {\n    for (let i = 0; i < this.trackAnalysis[type].length; i++) {\n      this.updateTrackProgress()\n\n      /** If last interval... */\n      if (i === (this.trackAnalysis[type].length - 1)) {\n        this.intervals.active[type] = this.trackAnalysis[type][i]\n        this.intervals.initial[type] = this.trackAnalysis[type][i]\n        this.intervals.active[type].index = i\n        this.intervals.initial[type].index = i\n\n        return\n      }\n\n      /** If current track progress falls within current interval. */\n      if (this.trackAnalysis[type][i].start < this.trackProgress.progress/1000 && this.trackProgress.progress/1000 < this.trackAnalysis[type][i + 1].start) {\n        this.intervals.active[type] = this.trackAnalysis[type][i]\n        this.intervals.initial[type] = this.trackAnalysis[type][i]\n        this.intervals.next[type] = this.trackAnalysis[type][i + 1]\n        this.intervals.active[type].index = i\n        this.intervals.initial[type].index = i\n        this.intervals.next[type].index = i + 1\n        break\n      }\n    }\n  }\n\n  executeIntervalHooks(type, interval, index, initialize) {       \n    this.intervals.active[type] = interval\n    this.intervals.next[type] = this.trackAnalysis[type][index + 1] || null\n    this.intervals.last[type] = this.trackAnalysis[type][index - 1] || null\n\n    if (typeof this.intervals.hooks[type] === 'function') {\n      this.updateTrackProgress()\n      this.intervals.hooks[type].bind(this, index).call()\n      this.updateTrackProgress()\n    }\n\n    let recursionDelay = 0\n\n    if (initialize === true) {      \n      recursionDelay = (this.intervals.next[type].start * 1000) - this.trackProgress.progress\n    } else {\n      recursionDelay = (interval.duration * 1000) - (this.trackProgress.progress - (interval.start * 1000))\n    }\n    this.intervals.active[type].timeout = setTimeout(() => {\n      this.executeIntervalHooks(type, this.intervals.next[type], index + 1, false)\n    }, recursionDelay)\n  }\n\n  removeHooks() {\n    this.intervals.types.forEach((type) => {\n      delete this.intervals.hooks[type]\n    });\n  }\n\n  initializeHooks() {    \n    this.intervals.types.forEach((type) => {\n      this.trackAnalysis[type][0] = {\n        ...this.trackAnalysis[type][0], \n        start: 0,\n        duration: this.trackAnalysis[type][0].start + this.trackAnalysis[type][0].duration\n      }\n\n      this.determineInitialIntervals(type)\n      this.executeIntervalHooks(type, this.intervals.active[type], this.intervals.active[type].index, true)\n    })\n  }\n}\n\nexport default SpotifyConnect"]}