{"version":3,"sources":["kaleidosync/spotify-connect.js"],"names":["SpotifyConnect","demo","accessToken","Cookies","get","refreshToken","refreshCode","api","Axios","create","baseURL","headers","Authorization","Accept","err","console","log","currentlyPlaying","trackAnalysis","trackProgress","trackFeatures","intervals","types","active","next","last","initial","hooks","forEach","type","delay","window","performance","now","Promise","resolve","reject","then","res","data","catch","item","id","reset","progress","timestamp","progress_ms","i","length","updateTrackProgress","index","start","interval","initialize","bind","call","recursionDelay","duration","timeout","setTimeout","executeIntervalHooks","determineInitialIntervals"],"mappings":"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","file":"spotify-connect.js","sourcesContent":["import Axios from '../lib/axios.min'\nimport Cookies from '../lib/js.cookie'\n\nclass SpotifyConnect {\n  constructor(demo) {\n    this.demo = demo\n\n    this.accessToken = Cookies.get('KALEIDOSYNC_ACCESS_TOKEN')\n    this.refreshToken = Cookies.get('KALEIDOSYNC_REFRESH_TOKEN')\n    this.refreshCode = Cookies.get('KALEIDOSYNC_REFRESH_CODE')\n\n    try {\n      this.api = Axios.create({\n        baseURL: 'https://api.spotify.com/v1',\n        headers: {\n          Authorization: 'Bearer ' + this.accessToken,\n          Accept: 'application/json'\n        }\n      })\n    } catch(err) {\n      console.log(err)\n    }\n\n    this.currentlyPlaying = {}\n    this.trackAnalysis = {} \n    this.trackProgress = {}\n    this.trackFeatures = {}\n\n    this.intervals = {\n      types: ['tatums', 'segments', 'beats', 'bars', 'sections'],\n      active: {},\n      next: {},\n      last: {},\n      initial: {},\n      hooks: {}\n    }\n\n    this.intervals.types.forEach((type) => {\n      this.intervals.active[type] = {}\n      this.intervals.next[type] = {}\n      this.intervals.last[type] = {}\n      this.intervals.initial[type] = {}\n      this.intervals.hooks[type] = () => {}\n    })\n  }\n\n  getCurrentlyPlaying() {\n    const delay = window.performance.now()\n\n    if (this.demo) {\n      return new Promise((resolve, reject) => {\n        Axios.get('/data/currently-playing.json')\n          .then((res) => resolve({...res.data, delay: window.performance.now() - delay}))\n          .catch((err) => reject(err))\n      })\n    }\n\n    return new Promise((resolve, reject) => {\n      this.api.get('/me/player/currently-playing')\n        .then((res) => resolve({...res.data, delay: window.performance.now() - delay}))\n        .catch((err) => reject(err))\n    })\n  }\n\n  getTrackFeatures() {\n    if (this.demo) {\n      return new Promise((resolve, reject) => {\n        Axios.get('/data/track-features.json')\n          .then((res) => resolve(res.data))\n          .catch((err) => reject(err))\n      })\n    }\n\n    return new Promise((resolve, reject) => {\n      this.api.get(`/audio-features/${this.currentlyPlaying.item.id}`)\n        .then((res) => resolve(res.data))\n        .catch((err) => reject(err))\n    })\n  }\n\n  getTrackAnalysis() {\n    if (this.demo) {\n      return new Promise((resolve, reject) => {\n        Axios.get('/data/track-analysis.json')\n          .then((res) => resolve(res.data))\n          .catch((err) => reject(err))\n      })\n    }\n\n    return new Promise((resolve, reject) => {\n      this.api.get(`/audio-analysis/${this.currentlyPlaying.item.id}`)\n        .then((res) => resolve(res.data))\n        .catch((err) => reject(err))\n    })\n  }\n\n  updateTrackProgress(delay, reset) {\n    if (reset) {\n      this.trackProgress = {\n        progress: 0,\n        timestamp: window.performance.now()\n      }\n      return\n    }\n\n    if (delay) {\n      this.trackProgress = {\n        progress: this.currentlyPlaying.progress_ms + delay,\n        timestamp: window.performance.now()\n      }\n      return\n    } \n\n    this.trackProgress = { \n      progress: this.trackProgress.progress + (window.performance.now() - this.trackProgress.timestamp),\n      timestamp: window.performance.now()\n    }\n  }\n\n  determineInitialIntervals(type) {\n    for (let i = 0; i < this.trackAnalysis[type].length; i++) {\n      this.updateTrackProgress()\n\n      /** If last interval... */\n      if (i === (this.trackAnalysis[type].length - 1)) {\n        this.intervals.active[type] = this.trackAnalysis[type][i]\n        this.intervals.initial[type] = this.trackAnalysis[type][i]\n        this.intervals.active[type].index = i\n        this.intervals.initial[type].index = i\n\n        return\n      }\n\n      /** If current track progress falls within current interval. */\n      if (this.trackAnalysis[type][i].start < this.trackProgress.progress/1000 && this.trackProgress.progress/1000 < this.trackAnalysis[type][i + 1].start) {\n        this.intervals.active[type] = this.trackAnalysis[type][i]\n        this.intervals.initial[type] = this.trackAnalysis[type][i]\n        this.intervals.next[type] = this.trackAnalysis[type][i + 1]\n        this.intervals.active[type].index = i\n        this.intervals.initial[type].index = i\n        this.intervals.next[type].index = i + 1\n        break\n      }\n    }\n  }\n\n  executeIntervalHooks(type, interval, index, initialize) {       \n    this.intervals.active[type] = interval\n    this.intervals.next[type] = this.trackAnalysis[type][index + 1] || null\n    this.intervals.last[type] = this.trackAnalysis[type][index - 1] || null\n\n    if (typeof this.intervals.hooks[type] === 'function') {\n      this.updateTrackProgress()\n      this.intervals.hooks[type].bind(this, index).call()\n      this.updateTrackProgress()\n    }\n\n    let recursionDelay = 0\n\n    if (initialize === true) {      \n      recursionDelay = (this.intervals.next[type].start * 1000) - this.trackProgress.progress\n    } else {\n      recursionDelay = (interval.duration * 1000) - (this.trackProgress.progress - (interval.start * 1000))\n    }\n    this.intervals.active[type].timeout = setTimeout(() => {\n      this.executeIntervalHooks(type, this.intervals.next[type], index + 1, false)\n    }, recursionDelay)\n  }\n\n  removeHooks() {\n    this.intervals.types.forEach((type) => {\n      delete this.intervals.hooks[type]\n    });\n  }\n\n  initializeHooks() {    \n    this.intervals.types.forEach((type) => {\n      this.trackAnalysis[type][0] = {\n        ...this.trackAnalysis[type][0], \n        start: 0,\n        duration: this.trackAnalysis[type][0].start + this.trackAnalysis[type][0].duration\n      }\n\n      this.determineInitialIntervals(type)\n      this.executeIntervalHooks(type, this.intervals.active[type], this.intervals.active[type].index, true)\n    })\n  }\n}\n\nexport default SpotifyConnect"]}